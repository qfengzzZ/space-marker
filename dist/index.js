import t from"lodash";function i(){return(4294967296*(1+Math.random())|0).toString(16).substring(1)}class s{x=0;y=0;constructor(t,i){this.x=t,this.y=i}}class e{constructor(t,i,e,h){this.x=t,this.y=i,this.width=e,this.height=h,this.ex=new s(t+e,i+h),this.center=new s(t+e/2,i+h/2),this.topCenter=new s(t+e/2,i)}}class h{bgColor=null;hoverColor=null;ext=null;points=[];borderRect=null;constructor(t,s){this.id=i(),this.options=t,this.spaceMaker=s,this.initOptions(),this.calcPoints(),this.calcBorderRect()}initOptions(){this.bgColor=t.get(this.options,"bgColor","rgba(247, 159, 58, 0.6)"),this.hoverColor=t.get(this.options,"hoverColor","rgba(247, 159, 58, 0.6)"),this.ext=t.get(this.options,"ext")}calcPoints(){const i=t.get(this.options,"points")||[];this.points=i.map(t=>[(t[0]-this.spaceMaker.mapImgRect.x)*this.spaceMaker.ratio,(t[1]-this.spaceMaker.mapImgRect.y)*this.spaceMaker.ratio])}calcBorderRect(){const i=this.points.map(t=>t[0]),s=this.points.map(t=>t[1]),h=t.min(i),a=t.max(i),o=t.min(s),r=t.max(s);this.borderRect=new e(h,o,a-h,r-o)}draw(){const t=this.spaceMaker.ctx;t.save(),t.beginPath(),t.moveTo(this.points[0][0],this.points[0][1]);for(let i=1;i<this.points.length;i++)t.lineTo(this.points[i][0],this.points[i][1]);t.closePath(),t.fillStyle=this.bgColor,this.isActive&&(t.fillStyle=this.hoverColor,t.strokeStyle=Color(this.hoverColor).alpha(.8).lighten(.2),t.lineWidth=2,t.stroke()),t.fill(),t.restore()}hit(t){let i=t.x,e=t.y,h=!1,a=this.points.map(t=>new s(t[0],t[1]));for(let t=0,s=a.length,o=s-1;t<s;o=t,t++){let s=a[t].x,r=a[t].y,n=a[o].x,g=a[o].y;if(s===i&&r===e||n===i&&g===e)return!0;if(r<e&&g>=e||r>=e&&g<e){let t=s+(e-r)*(n-s)/(g-r);if(t===i)return!0;t>i&&(h=!h)}}return h}setActive(t){this.isActive=t,this.spaceMaker.drawMapImage()}}class a{radius=0;padding=0;icon=null;bgColor="rgba(9, 140, 255, 0.8)";highlight=!1;highlightSize=8;ext=null;center={x:0,y:0};borderRect=null;centerRect=null;constructor(s,e){this.id=i(),this.options=s,this.spaceMaker=e,t.get(this.options,"w")&&(this.options.center.x=this.options.center.x*this.spaceMaker.mapImg.width/t.get(this.options,"w",1),this.options.center.y=this.options.center.y*this.spaceMaker.mapImg.height/t.get(this.options,"h",1)),this.initOptions(),this.parseIcon()}initOptions(){this.radius=t.get(this.options,"radius"),this.padding=t.get(this.options,"padding"),this.icon=t.get(this.options,"icon"),this.bgColor=t.get(this.options,"bgColor"),this.highlight=t.get(this.options,"highlight"),this.highlightSize=t.get(this.options,"highlightSize"),this.ext=t.get(this.options,"ext")}parseIcon(){this.icon.startsWith("http")?this.loadImg(this.icon):resources[`${this.icon}`]&&this.loadImg(resources[`${this.icon}`])}loadImg(t){t&&(this.iconImg=new Image,this.iconImg.crossOrigin="anonymous",this.iconImg.src=t,this.iconImg.onload=()=>{this.draw()})}draw(){if(this.calcCenter(),this.center.x<0||this.center.y<0||this.center.x>this.spaceMaker.map.width||this.center.y>this.spaceMaker.map.height)return;let t=this.spaceMaker.ctx;t.save(),this.highlight&&(t.beginPath(),t.arc(this.center.x,this.center.y,this.radius+this.highlightSize,0,2*Math.PI,!1),t.fillStyle=Color("rgba(9, 140, 255, 0.8)").alpha(.4).lighten(.5),t.fill(),t.strokeStyle=Color("rgba(9, 140, 255, 0.8)").alpha(.8).lighten(.2),t.lineWidth=1,t.stroke()),this.iconImg&&(t.beginPath(),t.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI,!1),t.fillStyle=this.bgColor,t.fill(),t.drawImage(this.iconImg,0,0,this.iconImg.width,this.iconImg.height,this.centerRect.x,this.centerRect.y,this.centerRect.width,this.centerRect.height)),t.restore()}calcCenter(){const i=(t.get(this.options,"center.x")-this.spaceMaker.mapImgRect.x)*this.spaceMaker.ratio,h=(t.get(this.options,"center.y")-this.spaceMaker.mapImgRect.y)*this.spaceMaker.ratio;this.center=new s(i,h);const a=this.radius-this.padding,o=this.radius-this.padding;this.centerRect=new e(this.center.x-a,this.center.y-o,2*a,2*o),this.borderRect=new e(this.center.x-this.radius,this.center.y-this.radius,2*this.radius,2*this.radius)}}class o{map=null;dpiRatio=1;radio=1;width=0;height=0;ctx=null;mapImg=null;mapImgUrl=null;translateImgTo=1e3;marks=[];ranges=[];mapImgRect=null;isDragStart=!1;startDragPos=null;mouseMoveType=null;timer=null;constructor(t,i){this.parentElem=t,this.resizeDpiRatio(),this.initialize(i),this.winResize()}resizeDpiRatio(){window.devicePixelRatio<2?this.dpiRatio=2:this.dpiRatio=window.devicePixelRatio}initialize(i){if(!this.parentElem)throw new Error("A DOM element is required for SpaceMaker to initialize");this.options=i,this.width=this.parentElem.clientWidth,this.height=this.parentElem.clientHeight,this.map&&this.map.remove(),this.map=function(t,i,s){const e=document.createElement("canvas");return e.width=t*s,e.height=i*s,e.style.width=t+"px",e.style.height=i+"px",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.outline="none",e}(this.width,this.height,this.dpiRatio),this.ctx=this.map.getContext("2d",{willReadFrequently:!0}),this.ctx.scale(this.dpiRatio,this.dpiRatio),this.parentElem.append(this.map),this.scaleX=t.get(this.options,"scaleX"),this.scaleY=t.get(this.options,"scaleY"),this.translateImgTo=t.get(this.options,"translateImgTo"),this.parseOptions(i),this.map.onmousemove=this.onMouseMove,this.map.onmousedown=this.onMouseDown,this.map.onmouseup=this.onMouseUp,this.map.onmouseleave=this.onMouseLeave,this.map.onwheel=this.onWheel}parseOptions(i){this.ctx.clearRect(0,0,this.width,this.height),this.marks=[],this.ranges=[],this.mapImgRect={x:0,y:0,width:t.get(i,"mapWidth")||0,height:t.get(i,"mapHeight")||0},this.loadMapImg(t.get(i,"mapImgUrl"),()=>{this.onComponentsLoad(i)})}loadMapImg(t,i=null){if(!t)throw new Error("src of picture is not found");this.mapImg=new Image,this.mapImg.crossOrigin="anonymous",this.mapImg.src=t,this.mapImg.onload=()=>{this.mapImgRect=this.coverCenter(this.width,this.height,this.mapImg.width,this.mapImg.height),i&&i()}}onComponentsLoad(i){const s=t.get(i,"marks")||[];t.isEmpty(s)||(this.marks=s.map(t=>new a(t,this)));const e=t.get(i,"ranges")||[];t.isEmpty(e)||(this.ranges=e.map(t=>new h(t,this))),this.drawMapImage(),this.dispatch("loaded",this)}drawMapImage(){this.mapImg&&this.mapImgRect&&this.ctx&&(this.ctx.clearRect(0,0,this.width,this.height),this.ctx.drawImage(this.mapImg,this.mapImgRect.x,this.mapImgRect.y,this.mapImgRect.width,this.mapImgRect.height,0,0,this.width,this.height),this.marks.forEach(t=>{t.draw()}),this.ranges.forEach(t=>{t.draw()}),this.dispatch("rendered",this))}dispatch(t,i){this.options.on&&this.options.on(t,i)}_resize(){const t=this.parentElem.clientWidth,i=this.parentElem.clientHeight;t===this.width&&i===this.height||requestAnimationFrame(()=>{this.width=t,this.height=i,this.map.width=this.width*this.dpiRatio,this.map.height=this.height*this.dpiRatio,this.map.style.width=this.width+"px",this.map.style.height=this.height+"px",this.ctx.scale(this.dpiRatio,this.dpiRatio),this.mapImgRect=this.coverCenter(this.width,this.height,this.mapImg.width,this.mapImg.height),this.drawMapImage()})}winResize=()=>{this.timer=setTimeout(()=>{this._resize(),this.timer=setTimeout(this.winResize,500)},500)};coverRect(t,i,s,e){let h=0,a=0,o=s,r=e;return s/e>t/i?(o=t/i*e,h=(s-o)/2):(r=i/t*s,a=(e-r)/2),this.ratio=t/o,{x:h,y:a,width:o,height:r}}coverCenter(t,i,s,e){let h=0,a=0,o=s,r=e;return s/e>t/i?(this.ratio=t/o,a=-(i/this.ratio-e)/2,r=i/this.ratio,h=-(t/this.ratio-s)/2):(this.ratio=i/r,h=-(t/this.ratio-s)/2,o=t/this.ratio,a=-(i/this.ratio-e)/2),{x:h,y:a,width:o,height:r}}onMouseMove=t=>{t.preventDefault(),t.stopPropagation();const i={x:t.x-this.map.getBoundingClientRect().x,y:t.y-this.map.getBoundingClientRect().y};this.mapHover(i),this.isDragStart&&this.mapMove(i)};mapHover(t){let i=!1,s=null;for(let e=this.marks.length-1;e>=0;e--)this.marks[e].hit({x:t.x/this.scaleX,y:t.y/this.scaleY})&&!i&&(i=!0,s=this.marks[e]);i&&s?(this.hoverMark&&this.hoverMark.id!==s.id&&(this.dispatch("mark_leave",this.hoverMark),this.hoverMark=null),(!this.hoverMark||this.hoverMark&&this.hoverMark.id!==s.id)&&(this.dispatch("mark_enter",s),this.hoverMark=s)):this.hoverMark&&(this.dispatch("mark_leave",this.hoverMark),this.hoverMark=null);let e=!1,h=null;for(let i=this.ranges.length-1;i>=0;i--)this.ranges[i].hit({x:t.x/this.scaleX,y:t.y/this.scaleY})&&!e?(e=!0,h=this.ranges[i]):this.ranges[i].isActive=!1;e&&h&&!i?(this.hoverRange&&this.hoverRange.id!==h.id&&(h.setActive(!1),this.dispatch("range_leave",{...this.hoverRange,pos:t}),this.hoverRange=null),(!this.hoverRange||this.hoverRange&&this.hoverRange.id!==h.id)&&(h.setActive(!0),this.dispatch("range_enter",{...h,pos:t}),this.hoverRange=h)):this.hoverRange&&(this.hoverRange.setActive(!1),this.dispatch("range_leave",this.hoverRange),this.hoverRange=null)}mapMove(t){const i=(t.x-this.startDragPos.x)/this.scaleX,s=(t.y-this.startDragPos.y)/this.scaleY;Math.abs(i)<5&&Math.abs(s)<5||(this.mouseMoveType="drag",this.startDragPos=t,this.mapImgRect.x-=i/this.ratio,this.mapImgRect.y-=s/this.ratio,requestAnimationFrame(()=>{this.drawMapImage()}))}onMouseDown=t=>{t.preventDefault(),t.stopPropagation(),this.isDragStart=!0,this.startDragPos={x:t.x-this.map.getBoundingClientRect().x,y:t.y-this.map.getBoundingClientRect().y}};onMouseUp=t=>{t.preventDefault(),t.stopPropagation(),this.isDragStart=!1;const i={x:t.x-this.map.getBoundingClientRect().x,y:t.y-this.map.getBoundingClientRect().y};"click"===this.mouseMoveType&&this.mapClick(i),this.mouseMoveType="click"};mapClick(t){const i=(t.x-this.startDragPos.x)/this.scaleX,s=(t.y-this.startDragPos.y)/this.scaleY;if(Math.abs(i)>5||Math.abs(s)>5)return;let e=!1,h=null;for(let i=this.marks.length-1;i>=0;i--)this.marks[i].hit({x:t.x/this.scaleX,y:t.y/this.scaleY})&&!e?(e=!0,h=this.marks[i]):this.marks[i].highlight=!1;e&&h?(h.setHighlight(!0),this.dispatch("mark_click",h)):this.drawMapImage();let a=!1,o=null;for(let i=this.ranges.length-1;i>=0;i--)this.ranges[i].hit({x:t.x/this.scaleX,y:t.y/this.scaleY})&&!a?(a=!0,o=this.ranges[i]):this.ranges[i].isActive=!1;a&&o&&!e?(o.setActive(!0),this.dispatch("range_click",o)):this.drawMapImage()}onMouseLeave=t=>{t.preventDefault(),t.stopPropagation(),this.isDragStart=!1};onWheel=t=>{t.preventDefault(),t.stopPropagation(),t.deltaY>0?this.mapTranslate({x:t.x-this.map.getBoundingClientRect().x,y:t.y-this.map.getBoundingClientRect().y},.9):this.mapTranslate({x:t.x-this.map.getBoundingClientRect().x,y:t.y-this.map.getBoundingClientRect().y},1.1)};mapTranslate(t,i){let s=(t={x:t.x/this.scaleX,y:t.y/this.scaleY}).x/this.ratio+this.mapImgRect.x,e=t.y/this.ratio+this.mapImgRect.y;this.ratio=this.ratio*i,this.mapImgRect.width=this.width/this.ratio,this.mapImgRect.height=this.height/this.ratio,this.mapImgRect.x=s-t.x/this.ratio,this.mapImgRect.y=e-t.y/this.ratio,requestAnimationFrame(()=>{this.drawMapImage()})}}export{o as SpaceMaker};
